---
title: "LAEI River data"
author: "James Smith"
output: html_document
date: "`r format(Sys.time(), '%Y-%m%-%d %H%:%M')`"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs") }) 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)
library(mapview)
library(leaflet)
library(tidyverse)
library(BAMMtools)
library(raster)
library(sp)
```

```{r, echo=F}
latlong = "+init=epsg:4326"
ukgrid = "+init=epsg:27700"
google = "+init=epsg:3857"
```

```{r import data, include=FALSE}

berths <- st_read('X:/Projects/PLA/GIS/Shapefiles/Berths.shp') %>% st_set_crs(27700)
berths <- berths[-179,]
river  <- st_read('X:/Projects/PLA/GIS/Shapefiles/River Thames Outline.shp') %>% st_set_crs(27700)
```

## Map of berths and river shapefile

```{r plot, echo=F}
mapview(berths, map.types = c("OpenStreetMap.BlackAndWhite")) %>% addFeatures(river)
```

## 100m grid of Thames emissions

```{r grid_emissions, echo=F}

emissions                   <- read_csv('emissions/inventory_export_2016.csv', col_types = cols())
emissions                   <- aggregate(data=emissions, cbind(Sailing_kg, AtBerth_kg) ~ Substance + CellID, FUN=sum)
emissions$CellID            <- as.numeric(emissions$CellID)

grid                        <- st_read('grids/LAEIGridExtensionV2.gpkg', quiet = T)

grid_emissions              <- merge(emissions, grid, by.x = 'CellID', by.y = 'GRID_ID') 
st_geometry(grid_emissions) <- grid_emissions$geom
```

Example of NOX while sailing

```{r sailing_nox, echo=F}
NOX <- grid_emissions[grid_emissions$Substance == 'NOx',]
```

```{r, echo=F}
mapview(NOX, map.types = c("OpenStreetMap.BlackAndWhite"), zcol = 'Sailing_kg', at = round(getJenksBreaks(NOX$Sailing_kg, 10),0))

rm(NOX)
```

Example of NOX while at berth

```{r berth_nox, echo=F}
NOX <- grid_emissions[grid_emissions$Substance == 'NOx',]
```

```{r, echo=F}
mapview(NOX, map.types = c("OpenStreetMap.BlackAndWhite"), zcol = 'AtBerth_kg', at = round(getJenksBreaks(NOX$AtBerth_kg, 10),0))

rm(NOX)
```

Now make a 10m x 10m grid covering the area of the river emissions.

```{r make_10m_grid, echo=FALSE, warning=FALSE}

new_grid                  <- raster(extent(grid_emissions), res=10, crs = ukgrid)
values(new_grid)          <- NA
names(new_grid)           <- 'sailing_points'

```

Now import one day of points from the processed AIS data (via Andrew)

```{r import_ais_data}

load('gps/apr1_AIS_decoded.Rdata')
gps_data <- data
rm(data)
coordinates(gps_data) <- ~lon+lat
proj4string(gps_data)  <- CRS(latlong)
gps_data <- spTransform(gps_data, CRS(ukgrid))

gps_data <- crop(gps_data, new_grid)

gps_data <- st_as_sf(gps_data) %>% st_set_crs(27700)

```

Take the berth points, buffer 30m around them and then tag all gps points that are within those buffers with the berth name

```{r tag_berth_points}

berths <- st_buffer(berths, 30)

gps_data <- st_join(gps_data, berths, join = st_intersects)

```

Now make two rasters. One for berth data, and one for moving data

```{r}

gps_data$time       <- 1

berth_grid          <- rasterize(gps_data[!is.na(gps_data$berth_name),1], new_grid, fun=sum)
sailing_grid        <- rasterize(gps_data[is.na(gps_data$berth_name),1], new_grid, fun=sum)

names(berth_grid)   <- c('id', 'count')
names(sailing_grid) <- c('id', 'count')

```

Aggregate the 10m count up to 100m so that know the number of points in each 100m cell

```{r aggregate_up_to_100m}

berth_hundred_grid   <- aggregate(berth_grid, fact = 10, fun=sum)
sailing_hundred_grid <- aggregate(sailing_grid, fact = 10, fun=sum)

```

Then take the resolution back to 10m but keeping the number of points in each 100m 'block' the same

```{r disagreggate_down_to_10m}

berth_ten_grid     <- disaggregate(berth_hundred_grid, fact = 10, fun = NA)
sailing_ten_grid   <- disaggregate(sailing_hundred_grid, fact = 10, fun = NA)

```

Now divide the number of points in each 10m grid, by the number of points in the surrounding 100m grid, to find out what percent of the 100m emissions each 10m grid cell is allocated

```{r divide_10m_by_100m}

berth_grid    <- berth_grid   / berth_ten_grid
sailing_grid  <- sailing_grid / sailing_ten_grid

rm(emissions, gps_data, grid, hundred_grid, new_grid, ten_grid)

names(berth_grid)   <- c('id','percent_of_gps_points_in_100m')
names(sailing_grid) <- c('id','percent_of_gps_points_in_100m')

```

Make the berths into polygons.