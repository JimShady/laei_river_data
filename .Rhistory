small_grid_result %>% filter(large_grid_id == 9559) %>% group_by(large_grid_id, group, pollutant) %>% summarise(count = sum(count, na.rm=T))
grid_emissions
small_grid_result %>% group_by(large_grid_id, group, pollutant) %>% summarise(count = sum(count, na.rm=T))
## Check if any large grids where we have emissions but no GPS
test <- small_grid_result %>%
group_by(large_grid_id, group, pollutant) %>%
summarise(count = sum(count, na.rm=T)) %>%
left_join(grid_emissions, ., by = c('group' = 'group', 'pollutant' = 'pollutant', 'large_grid_id' = 'large_grid_id'))
test
filter(test, count == 0 & (sailing > 0 | bert > 0))
filter(test, count == 0 & (sailing > 0 | berth > 0))
filter(test, count == 0 & (sailing > 0 | berth > 0)) %>% print(n=62)
summary(grid_emissions$sailing)
aggregate(data=grid+emissions, sailing ~ pollutant, FUN=mean)
aggregate(data=grid_emissions, sailing ~ pollutant, FUN=mean)
aggregate(data=grid+emissions, sailing ~ pollutant, FUN=summary)
aggregate(data=grid_emissions, sailing ~ pollutant, FUN=summary)
nrow(filter(test, count == 0 & (sailing > 0 | berth > 0)))
filter(test, count == 0 & (sailing > 0 | berth > 0)) %>% ggplot() + geom_sf()
filter(test, count == 0 & (sailing > 0 | berth > 0)) %>% ggplot() + geom_sf() + geom_sf(data=the_thames)
the_thames
filter(test, count == 0 & (sailing > 0 | berth > 0)) %>% ggplot() + geom_sf() + geom_sf(data=st_transform(the_thames, 27700))
filter(test, count == 0 & (sailing > 0 | berth > 0)) %>% ggplot() + geom_sf()
filter(test, count == 0 & (sailing > 0 | berth > 0))
st_write(test, 'temp/large_grid_output.gpkg')
test %>% filter(sailing == 0 & berth == 0)
filter(test, count == 0 & (sailing > 0 | berth > 0))
filter(test, count == 0 & (sailing > 0 | berth > 0)) %>% group_by(pollutant) %>% summarise(total = sum(sailing))
filter(test, count == 0 & (sailing > 0 | berth > 0)) %>% group_by(pollutant) %>% summarise(total = sum(sailing, na.rm=T))
test %>% group_by(pollutant) %>% summarise(total = sum(sailing, na.rm=T))
rm(list=ls(all=TRUE))
library(sf)
library(tidyverse)
library(scales)
library(snowfall)
## Script to process river emissions and GPS data.
## Key datasets test edit
## 1. 365 GPS days. Need lat, lon, and VESSEL_TYPE
## 2. Vessel classifications. vessel_classifications.csv . Gives vessel type, and group.
## 3. The emissions emissions/inventory_export_2016.csv' which are by LAEI exact cut over London
## 4. A shapefile of the grid exact cut
latlong = "+init=epsg:4326"
ukgrid  = "+init=epsg:27700"
google  = "+init=epsg:3857"
the_thames <- st_read('https://raw.githubusercontent.com/KCL-ERG/useful_geography/master/thames.geojson')
## Import the ship classifications
vessel_class              <- read_csv('docs/vessel_classifications.csv')
vessel_class$code         <- as.character(vessel_class$code)
# Get emissions by exact cut, substance and vessel type
emissions                 <- read_csv('emissions/inventory_export_2016.csv', col_types = cols())
emissions                 <- emissions[emissions$LAEIPLAExt == 'LAEI',]
emissions                 <- emissions[,c('VesselType', 'Substance', 'CellID', 'Sailing_kg', 'AtBerth_kg')]
emissions$CellID          <- as.numeric(emissions$CellID)
names(emissions)          <- c('ship_type', 'pollutant', 'cellid', 'sailing', 'berth')
pollutants_we_want        <- c('PM', 'PM2.5', 'NOx')
emissions                 <- emissions[emissions$pollutant %in% pollutants_we_want,]
rm(pollutants_we_want)
# Tidy up some of the vessel classifications in the emissions file to match the GPS ecssel types
emissions[emissions$ship_type == 'RoRo Cargo / Vehicle','ship_type'] <-'RoRo Cargo/Vehicle'
emissions[emissions$ship_type == 'Cruise ship','ship_type']          <-'Passenger (cruise)'
emissions[emissions$ship_type == 'Passenger', 'ship_type']           <-'Passenger (ferry)'
# Add vessel group type to the emissions, for matching with GPS data
emissions                 <- left_join(emissions, unique(vessel_class[,c('aggregated_class', 'group')]),
by = c('ship_type' = 'aggregated_class'))
# Now aggregte
emissions <- emissions %>%
select(-ship_type) %>%
group_by(pollutant, cellid, group) %>%
summarise(sailing = sum(sailing, na.rm=T),
berth   = sum(berth, na.rm=T)) %>%
ungroup()
# Now get the grid by exact cut
grid                      <- st_read('grids/LAEIGridExtensionV2.gpkg', quiet = T)
# Link grid exact cut to eimssions exact cut, and remove some unncecessary data
grid_emissions            <- left_join(emissions, grid, by = c('cellid' = 'CellID')) %>%
rename(large_grid_id = GRID_ID0, x = X_COORD, y = Y_COORD) %>%
select(cellid, large_grid_id, x, y, pollutant, group, sailing, berth) %>%
as.tibble() %>%
group_by(pollutant, group, large_grid_id, x, y) %>%
summarise(sailing = sum(sailing), berth = sum(berth)) %>%
st_as_sf(coords = c("x", "y"), crs=27700) %>%
st_buffer(dist = 500, endCapStyle= "SQUARE")
rm(emissions, grid)
ggplot() +
geom_sf(data = filter(grid_emissions, pollutant == 'NOx' & group == 1), colour = NA, aes(fill = sailing)) +
scale_fill_distiller(palette = 'RdYlGn') +
ggtitle('Sailing emissions: NOx group 1')
plot <- ggplot() +
geom_sf(data = filter(grid_emissions, pollutant == 'NOx' & group == 1), colour = NA, aes(fill = sailing)) +
scale_fill_distiller(palette = 'RdYlGn') +
ggtitle('Sailing emissions: NOx group 1')
ggsave('large_grid_sailing_group_one_nox.png', plot = plot, path = 'maps/', height = 5, width = 15, units='cm')
plot <- ggplot() +
geom_sf(data = filter(grid_emissions, pollutant == 'NOx' & group == 1), colour = NA, aes(fill = berth)) +
scale_fill_distiller(palette = 'RdYlGn') +
ggtitle('Berth emissions: NOx group 1')
ggsave('large_grid_berth_group_one_nox.png', plot = plot, path = 'maps/', height = 5, width = 15, units='cm')
grid_emissions
small_grid                         <- unique(grid_emissions[,c('large_grid_id','geometry')]) %>%
st_make_grid(cellsize = 20, what = 'polygons') %>%
st_sf() %>%
st_intersection(unique(grid_emissions[,c('large_grid_id','geometry')])) %>%
mutate(small_grid_id = row_number())
## Make a small  grid results dataset that we'll count the GPS points into
small_grid_result         <- rbind(small_grid %>% mutate(group = 1),
small_grid %>% mutate(group = 2),
small_grid %>% mutate(group = 3),
small_grid %>% mutate(group = 4))
small_grid_result
filter(small_grid_result, large_grid_id == 10400)
filter(small_grid_result, large_grid_id == 10400 & group = 1)
filter(small_grid_result, large_grid_id == 10400 & group == 1)
filter(small_grid_result, large_grid_id %in% c(10399,10400) & group == 1)
ggplot(filter(small_grid_result, large_grid_id %in% c(10399,10400) & group == 1)) + geom_sf()
ggplot(filter(small_grid_result, large_grid_id %in% c(10399,10400) & group == 1)) + geom_sf(aes(colour = large_grid_id))
ggplot(filter(small_grid_result, large_grid_id %in% c(10399,10400) & group == 1)) + geom_sf(aes(colour = as.factor(large_grid_id)))
ggplot(filter(small_grid_result, large_grid_id %in% c(10399,10400) & group == 1)) + geom_sf(aes(colour = as.factor(large_grid_id))) + geom_sf(the_thames)
ggplot(filter(small_grid_result, large_grid_id %in% c(10399,10400) & group == 1)) + geom_sf(aes(colour = as.factor(large_grid_id))) + geom_sf(data=the_thames)
## Plot small grid as example
plot <- ggplot(filter(small_grid_result, large_grid_id %in% c(10399,10400) & group == 1)) +
geom_sf(aes(colour = as.factor(large_grid_id))) +
geom_sf(data=st_crop(st_transform(the_thames,27700), filter(small_grid_result, large_grid_id %in% c(10399,10400) & group == 1)))
plot
## Plot small grid as example
plot <- ggplot() +
geom_sf(data=filter(small_grid_result, large_grid_id %in% c(10399,10400) & group == 1), aes(colour = as.factor(large_grid_id))) +
geom_sf(data=st_crop(st_transform(the_thames,27700),
filter(small_grid_result, large_grid_id %in% c(10399,10400) & group == 1)), fill=NA, colour = 'blue')
plot
## Plot small grid as example
plot <- ggplot() +
geom_sf(data=filter(small_grid_result, large_grid_id %in% c(10399,10400) & group == 1), aes(colour = as.factor(large_grid_id))) +
geom_sf(data=st_crop(st_transform(the_thames,27700),
filter(small_grid_result, large_grid_id %in% c(10399,10400) & group == 1)), fill=NA, colour = 'blue') +
theme(legend.position = 'none') +
ggtitle('Small grid example')
ggsave('small_grid_example.png', plot = plot, path = 'maps/', height = 5, width = 15, units='cm')
## Plot small grid as example
plot <- ggplot() +
geom_sf(data=filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group == 1), aes(colour = as.factor(large_grid_id)), size=0.5) +
geom_sf(data=st_crop(st_transform(the_thames,27700),
filter(small_grid_result, large_grid_id %in% c(10399,10400) & group == 1)), fill=NA, colour = 'blue') +
theme(legend.position = 'none', axis.text = element_blank()) +
ggtitle('Small grid example')
ggsave('small_grid_example.png', plot = plot, path = 'maps/', height = 5, width = 15, units='cm')
## Plot small grid as example
plot <- ggplot() +
geom_sf(data=filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group == 1), aes(colour = as.factor(large_grid_id)), size=0.5) +
geom_sf(data=st_crop(st_transform(the_thames,27700),
filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group == 1)), fill=NA, colour = 'blue') +
theme(legend.position = 'none', axis.text = element_blank(), axis.ticks = element_blank()) +
ggtitle('Small grid example')
ggsave('small_grid_example.png', plot = plot, path = 'maps/', height = 5, width = 15, units='cm')
rm(plot)
small_grid
list_of_small_grid_gps_result_data             <- list.files('grids/', full.names=T, pattern = 'small')
for (i in 1:length(list_of_small_grid_gps_result_data)) {
load(list_of_small_grid_gps_result_data[i])
if (i == 1) {
gps_per_small_grid_bind <- gps_per_small_grid_id
} else {
gps_per_small_grid_bind <- bind_rows(gps_per_small_grid_bind,gps_per_small_grid_id)
}
}
rm(list_of_small_grid_gps_result_data, gps_per_small_grid_id, i, small_grid)
# And do the same for the small exact cut grids
gps_per_small_grid        <- gps_per_small_grid_bind %>%
group_by(small_grid_id, group) %>%
summarise(count = sum(count))
rm(gps_per_small_grid_bind)
## Now need to join to the result grids I made
small_grid_result         <- left_join(small_grid_result, gps_per_small_grid,
by = c("small_grid_id" = "small_grid_id", "group" = "group"))
rm(gps_per_small_grid)
## Plot of small grid result, for large_grid_id 9886
plot <- ggplot(data=filter(small_grid_result, large_grid_id == 9886)) +
geom_sf(aes(fill=count), colour=NA) +
facet_wrap(.~group, nrow = 1) +
scale_fill_distiller(palette="Spectral", na.value="transparent") +
ggtitle('Count of annual GPS points in large_grid_id 9886')
ggsave('small_grid_gps_count_9886.png', plot = plot, path = 'maps/', height = 5, width = 15, units='cm')
ggplot(data=filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group = 1)) +
geom_sf(aes(fill=count), colour=NA) +
scale_fill_distiller(palette="Spectral", na.value="transparent") +
geom_sf(data=st_crop(st_transform(the_thames,27700),
filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group == 1)), fill=NA, colour = 'blue') +
ggtitle('Count of annual GPS points in large_grid_id 9886')
ggplot(data=filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group = 1)) +
geom_sf(aes(fill=count), colour=NA) +
scale_fill_distiller(palette="Spectral", na.value="transparent")
filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group = 1)
ggplot(data=filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group == 1)) +
geom_sf(aes(fill=count), colour=NA) +
scale_fill_distiller(palette="Spectral", na.value="transparent") +
geom_sf(data=st_crop(st_transform(the_thames,27700),
filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group == 1)), fill=NA, colour = 'blue') +
ggtitle('Count of annual GPS points in large_grid_id 9886')
plot <- ggplot(data=filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group == 1)) +
geom_sf(aes(fill=count), colour=NA) +
scale_fill_distiller(palette="Spectral", na.value="transparent") +
geom_sf(data=st_crop(st_transform(the_thames,27700),
filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group == 1)), fill=NA, colour = 'blue') +
theme(legend.position = 'none', axis.text = element_blank(), axis.ticks = element_blank()) +
ggtitle('Count of annual GPS points in large_grid_ids 10399,10400,10401 for group 1')
ggsave('small_grid_gps_count_example.png', plot = plot, path = 'maps/', height = 5, width = 15, units='cm')
rm(plot)
plot <- ggplot(data=filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group == 1)) +
geom_sf(aes(fill=count), colour=NA) +
scale_fill_distiller(palette="Spectral", na.value="transparent") +
geom_sf(data=st_crop(st_transform(the_thames,27700),
filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group == 1)), fill=NA, colour = 'blue') +
theme(axis.text = element_blank(), axis.ticks = element_blank(), legend.title = element_text(size=12)) +
ggtitle('Example of GPS counts')
ggsave('small_grid_gps_count_example.png', plot = plot, path = 'maps/', height = 5, width = 15, units='cm')
rm(plot)
berths <- st_read('shapefiles/Berths.shp') %>% select(berth_name) %>% st_set_crs(27700)
berths
small_grid_result <- small_grid_result %>%
st_join(berths, join = st_intersects, left = TRUE)
small_grid_result$berth_name <- as.character(small_grid_result$berth_name)
##
large_grid_sailing_counts <- aggregate(data=small_grid_result[!is.na(small_grid_result$count) & is.na(small_grid_result$berth_name),],  count ~ group + large_grid_id, FUN=sum)
large_grid_berth_counts   <- aggregate(data=small_grid_result[!is.na(small_grid_result$count) & !is.na(small_grid_result$berth_name),], count ~ group + large_grid_id, FUN=sum)
names(large_grid_sailing_counts)[3] <- 'sailing_count'
names(large_grid_berth_counts)[3]   <- 'berth_count'
small_grid_result
small_grid_result <- small_grid_result %>% left_join(large_grid_sailing_counts, by = c("large_grid_id" = "large_grid_id",
"group" = "group")) %>%
left_join(large_grid_berth_counts,   by = c("large_grid_id" = "large_grid_id",
"group" = "group"))
rm(large_grid_sailing_counts, large_grid_berth_counts)
# Calculate the contribution percentages
small_grid_result$contribution <- NA
small_grid_result[is.na(small_grid_result$berth_name),'contribution'] <-  small_grid_result[is.na(small_grid_result$berth_name),]$count /
small_grid_result[is.na(small_grid_result$berth_name),]$sailing_count
small_grid_result[!is.na(small_grid_result$berth_name),'contribution'] <- small_grid_result[!is.na(small_grid_result$berth_name),]$count /
small_grid_result[!is.na(small_grid_result$berth_name),]$berth_count
small_grid_result
filter(small_grid_result, !is.na(count))
small_grid_result    <-   rbind(small_grid_result %>% mutate(pollutant = 'NOx'),
small_grid_result %>% mutate(pollutant = 'PM'),
small_grid_result %>% mutate(pollutant = 'PM2.5'))
grid_emissions$geometry <- NULL
small_grid_result         <-  left_join(small_grid_result, grid_emissions, by = c("large_grid_id" = "large_grid_id",
"group" = "group",
"pollutant" = "pollutant"))
small_grid_result$emissions <- NA
small_grid_result[is.na(small_grid_result$berth_name),'emissions'] <-  small_grid_result[is.na(small_grid_result$berth_name),]$contribution *
small_grid_result[is.na(small_grid_result$berth_name),]$sailing
small_grid_result[!is.na(small_grid_result$berth_name),'emissions'] <-  small_grid_result[!is.na(small_grid_result$berth_name),]$contribution *
small_grid_result[!is.na(small_grid_result$berth_name),]$berth
small_grid_result
small_grid_result %>%
as_tibble() %>%
group_by(large_grid_id, pollutant, group) %>%
summarise(gps_count = sum(count, na.rm=T)) %>%
left_join(grid_emissions, ., by = c("large_grid_id" = "large_grid_id",
"group"="group",
"pollutant"="pollutant")) %>%
filter(gps_count == 0 & (sailing > 0 | berth > 0))
small_grid_result %>%
as_tibble() %>%
group_by(large_grid_id, pollutant, group) %>%
summarise(gps_count = sum(count, na.rm=T)) %>%
left_join(grid_emissions, ., by = c("large_grid_id" = "large_grid_id",
"group"="group",
"pollutant"="pollutant")) %>%
filter(gps_count == 0 & (sailing > 0 | berth > 0)) %>% group_by(pollutant) %>% summarise(sailing = sum(sailing), berth = sum(berth))
grid_emissions
grid_emissions %>% group_by(pollutant) %>% summarise(sailing = sum(sailing), berth = sum(berth))
small_grid_result %>%
as_tibble() %>%
group_by(large_grid_id, pollutant, group) %>%
summarise(gps_count = sum(count, na.rm=T)) %>%
left_join(grid_emissions, ., by = c("large_grid_id" = "large_grid_id",
"group"="group",
"pollutant"="pollutant")) %>%
filter(gps_count == 0 & (sailing > 0 | berth > 0)) %>% group_by(pollutant) %>% summarise(sailing = sum(sailing), berth = sum(berth)) %>% left_join((grid_emissions %>% group_by(pollutant) %>% summarise(sailing = sum(sailing), berth = sum(berth))))
filter(small_grid_result, group == 1 & pollutant == 'NOx')
filter(small_grid_result, group == 1 & pollutant == 'NOx' & !is.na(emissions#))
filter(small_grid_result, group == 1 & pollutant == 'NOx' & !is.na(emissions))
filter(small_grid_result, group == 1 & pollutant == 'NOx' & !is.na(emissions)) %>% select(emissions)
ggplot(data = filter(small_grid_result, group == 1 & pollutant == 'NOx' & !is.na(emissions) & large_grid_id %in% c(10399,10400,10401))) %>%
geom_sf()
ggplot(data = filter(small_grid_result, group == 1 & pollutant == 'NOx' & !is.na(emissions) & large_grid_id %in% c(10399,10400,10401))) +
geom_sf()
ggplot(data = filter(small_grid_result, group == 1 & pollutant == 'NOx' & !is.na(emissions) & large_grid_id %in% c(10399,10400,10401))) +
geom_sf(colour = NA, aes(fill = emissions))
ggplot(data = filter(small_grid_result, group == 1 & pollutant == 'NOx' & !is.na(emissions) & large_grid_id %in% c(10399,10400,10401))) +
geom_sf(colour = NA, aes(fill = emissions)) +
scale_fill_distiller(palette = 'RdYlGn')
ggplot(data = filter(small_grid_result, group == 1 & pollutant == 'NOx' & !is.na(emissions) & large_grid_id %in% c(10399,10400,10401))) +
geom_sf(colour = NA, aes(fill = emissions)) +
scale_fill_distiller(palette = 'Spectral') +
theme()
ggplot(data = filter(small_grid_result, group == 1 & pollutant == 'NOx' & !is.na(emissions) & large_grid_id %in% c(10399,10400,10401))) +
geom_sf(colour = NA, aes(fill = emissions)) +
scale_fill_distiller(palette = 'Spectral') +
theme(axis.text = element_blank(), axis.ticks = element_blank(), legend.title = element_text(size=12)) +
ggtitle('NOx group 1 emissions')
ggplot(data = filter(small_grid_result, group == 1 & pollutant == 'NOx' & !is.na(emissions) & large_grid_id %in% c(10399,10400,10401))) +
geom_sf(colour = NA, aes(fill = emissions)) +
geom_sf(data=st_crop(st_transform(the_thames,27700),
filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group == 1)), fill=NA, colour = 'blue') +
scale_fill_distiller(palette = 'Spectral') +
theme(axis.text = element_blank(), axis.ticks = element_blank(), legend.title = element_text(size=12)) +
ggtitle('NOx group 1 emissions')
ggplot(data = filter(small_grid_result, group == 2 & pollutant == 'NOx' & !is.na(emissions) & large_grid_id %in% c(10399,10400,10401))) +
geom_sf(colour = NA, aes(fill = emissions)) +
geom_sf(data=st_crop(st_transform(the_thames,27700),
filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group == 1)), fill=NA, colour = 'blue') +
scale_fill_distiller(palette = 'Spectral') +
theme(axis.text = element_blank(), axis.ticks = element_blank(), legend.title = element_text(size=12)) +
ggtitle('NOx group 2 emissions')
ggsave('nox_group_2_result_emissions.png', plot = plot, path = 'maps/', height = 5, width = 15, units='cm')
ggplot(data = filter(small_grid_result, group == 2 & pollutant == 'PM2.5' & !is.na(emissions) & large_grid_id %in% c(10399,10400,10401))) +
geom_sf(colour = NA, aes(fill = emissions)) +
geom_sf(data=st_crop(st_transform(the_thames,27700),
filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group == 1)), fill=NA, colour = 'blue') +
scale_fill_distiller(palette = 'Spectral') +
theme(axis.text = element_blank(), axis.ticks = element_blank(), legend.title = element_text(size=12)) +
ggtitle('NOx group 2 emissions')
plot <- ggplot(data = filter(small_grid_result, group == 1 & pollutant == 'NOx' & !is.na(emissions) & large_grid_id %in% c(10399,10400,10401))) +
geom_sf(colour = NA, aes(fill = emissions)) +
geom_sf(data=st_crop(st_transform(the_thames,27700),
filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group == 1)), fill=NA, colour = 'blue') +
scale_fill_distiller(palette = 'Spectral') +
theme(axis.text = element_blank(), axis.ticks = element_blank(), legend.title = element_text(size=12)) +
ggtitle('NOx group 1 emissions')
ggsave('nox_group_1_result_emissions.png', plot = plot, path = 'maps/', height = 5, width = 15, units='cm')
rm(plot)
plot <- ggplot(data = filter(small_grid_result, group == 2 & pollutant == 'NOx' & !is.na(emissions) & large_grid_id %in% c(10399,10400,10401))) +
geom_sf(colour = NA, aes(fill = emissions)) +
geom_sf(data=st_crop(st_transform(the_thames,27700),
filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group == 1)), fill=NA, colour = 'blue') +
scale_fill_distiller(palette = 'Spectral') +
theme(axis.text = element_blank(), axis.ticks = element_blank(), legend.title = element_text(size=12)) +
ggtitle('NOx group 2 emissions')
ggsave('nox_group_2_result_emissions.png', plot = plot, path = 'maps/', height = 5, width = 15, units='cm')
rm(plot)
plot <- ggplot(data = filter(small_grid_result, group == 2 & pollutant == 'PM2.5' & !is.na(emissions) & large_grid_id %in% c(10399,10400,10401))) +
geom_sf(colour = NA, aes(fill = emissions)) +
geom_sf(data=st_crop(st_transform(the_thames,27700),
filter(small_grid_result, large_grid_id %in% c(10399,10400,10401) & group == 1)), fill=NA, colour = 'blue') +
scale_fill_distiller(palette = 'Spectral') +
theme(axis.text = element_blank(), axis.ticks = element_blank(), legend.title = element_text(size=12)) +
ggtitle('PM2.5 group 2 emissions')
ggsave('pm25_group_2_result_emissions.png', plot = plot, path = 'maps/', height = 5, width = 15, units='cm')
rm(plot)
ggplot(data = filter(small_grid_result, group == 2 & pollutant == 'NOx' & !is.na(emissions) & large_grid_id %in% c(10066, 9894, 9895, 10067))) +
geom_sf(colour = NA, aes(fill = emissions))
ggplot(data = filter(small_grid_result, group == 2 & pollutant == 'NOx' & !is.na(emissions) & large_grid_id %in% c(10066, 9894, 9895, 10067))) +
geom_sf(colour = NA, aes(fill = emissions)) +
scale_fill_distiller(palette = 'Spectral')
st_write(small_grid_result, 'temp/small_grid_result.shp')
small_grid_result
rm(list=ls(all=TRUE))
rm(list=ls(all=TRUE))
library(sf)
library(tidyverse)
library(scales)
library(snowfall)
## Script to process river emissions and GPS data.
## Key datasets test edit
## 1. 365 GPS days. Need lat, lon, and VESSEL_TYPE
## 2. Vessel classifications. vessel_classifications.csv . Gives vessel type, and group.
## 3. The emissions emissions/inventory_export_2016.csv' which are by LAEI exact cut over London
## 4. A shapefile of the grid exact cut
latlong = "+init=epsg:4326"
ukgrid  = "+init=epsg:27700"
google  = "+init=epsg:3857"
the_thames <- st_read('https://raw.githubusercontent.com/KCL-ERG/useful_geography/master/thames.geojson')
## Import the ship classifications
vessel_class              <- read_csv('docs/vessel_classifications.csv')
vessel_class$code         <- as.character(vessel_class$code)
# Get emissions by exact cut, substance and vessel type
emissions                 <- read_csv('emissions/inventory_export_2016.csv', col_types = cols())
emissions                 <- emissions[emissions$LAEIPLAExt == 'LAEI',]
emissions                 <- emissions[,c('VesselType', 'Substance', 'CellID', 'Sailing_kg', 'AtBerth_kg')]
emissions$CellID          <- as.numeric(emissions$CellID)
names(emissions)          <- c('ship_type', 'pollutant', 'cellid', 'sailing', 'berth')
pollutants_we_want        <- c('PM', 'PM2.5', 'NOx')
emissions                 <- emissions[emissions$pollutant %in% pollutants_we_want,]
rm(pollutants_we_want)
# Tidy up some of the vessel classifications in the emissions file to match the GPS ecssel types
emissions[emissions$ship_type == 'RoRo Cargo / Vehicle','ship_type'] <-'RoRo Cargo/Vehicle'
emissions[emissions$ship_type == 'Cruise ship','ship_type']          <-'Passenger (cruise)'
emissions[emissions$ship_type == 'Passenger', 'ship_type']           <-'Passenger (ferry)'
# Add vessel group type to the emissions, for matching with GPS data
emissions                 <- left_join(emissions, unique(vessel_class[,c('aggregated_class', 'group')]),
by = c('ship_type' = 'aggregated_class'))
# Now aggregte
emissions <- emissions %>%
select(-ship_type) %>%
group_by(pollutant, cellid, group) %>%
summarise(sailing = sum(sailing, na.rm=T),
berth   = sum(berth, na.rm=T)) %>%
ungroup()
# Now get the grid by exact cut
grid                      <- st_read('grids/LAEIGridExtensionV2.gpkg', quiet = T)
# Link grid exact cut to eimssions exact cut, and remove some unncecessary data
grid_emissions            <- left_join(emissions, grid, by = c('cellid' = 'CellID')) %>%
rename(large_grid_id = GRID_ID0, x = X_COORD, y = Y_COORD) %>%
select(cellid, large_grid_id, x, y, pollutant, group, sailing, berth) %>%
as.tibble() %>%
group_by(pollutant, group, large_grid_id, x, y) %>%
summarise(sailing = sum(sailing), berth = sum(berth)) %>%
st_as_sf(coords = c("x", "y"), crs=27700) %>%
st_buffer(dist = 500, endCapStyle= "SQUARE")
rm(emissions, grid)
## Setup the small grids
small_grid                         <- unique(grid_emissions[,c('large_grid_id','geometry')]) %>%
st_make_grid(cellsize = 20, what = 'polygons') %>%
st_sf() %>%
st_intersection(unique(grid_emissions[,c('large_grid_id','geometry')])) %>%
mutate(small_grid_id = row_number())
## Make a small  grid results dataset that we'll count the GPS points into
small_grid_result         <- rbind(small_grid %>% mutate(group = 1),
small_grid %>% mutate(group = 2),
small_grid %>% mutate(group = 3),
small_grid %>% mutate(group = 4))
## Tidy
rm(process_gps_data, list_of_gps_data)
list_of_small_grid_gps_result_data             <- list.files('grids/', full.names=T, pattern = 'small')
for (i in 1:length(list_of_small_grid_gps_result_data)) {
load(list_of_small_grid_gps_result_data[i])
if (i == 1) {
gps_per_small_grid_bind <- gps_per_small_grid_id
} else {
gps_per_small_grid_bind <- bind_rows(gps_per_small_grid_bind,gps_per_small_grid_id)
}
}
rm(list_of_small_grid_gps_result_data, gps_per_small_grid_id, i, small_grid)
gps_per_small_grid        <- gps_per_small_grid_bind %>%
group_by(small_grid_id, group) %>%
summarise(count = sum(count))
rm(gps_per_small_grid_bind)
small_grid_result
rm(list=ls(all=TRUE))
library(sf)
library(tidyverse)
library(scales)
library(snowfall)
## Script to process river emissions and GPS data.
## Key datasets test edit
## 1. 365 GPS days. Need lat, lon, and VESSEL_TYPE
## 2. Vessel classifications. vessel_classifications.csv . Gives vessel type, and group.
## 3. The emissions emissions/inventory_export_2016.csv' which are by LAEI exact cut over London
## 4. A shapefile of the grid exact cut
latlong = "+init=epsg:4326"
ukgrid  = "+init=epsg:27700"
google  = "+init=epsg:3857"
the_thames <- st_read('https://raw.githubusercontent.com/KCL-ERG/useful_geography/master/thames.geojson')
## Import the ship classifications
vessel_class              <- read_csv('docs/vessel_classifications.csv')
vessel_class$code         <- as.character(vessel_class$code)
# Get emissions by exact cut, substance and vessel type
emissions                 <- read_csv('emissions/inventory_export_2016.csv', col_types = cols())
emissions                 <- emissions[emissions$LAEIPLAExt == 'LAEI',]
emissions                 <- emissions[,c('VesselType', 'Substance', 'CellID', 'Sailing_kg', 'AtBerth_kg')]
emissions$CellID          <- as.numeric(emissions$CellID)
names(emissions)          <- c('ship_type', 'pollutant', 'cellid', 'sailing', 'berth')
pollutants_we_want        <- c('PM', 'PM2.5', 'NOx')
emissions                 <- emissions[emissions$pollutant %in% pollutants_we_want,]
rm(pollutants_we_want)
# Tidy up some of the vessel classifications in the emissions file to match the GPS ecssel types
emissions[emissions$ship_type == 'RoRo Cargo / Vehicle','ship_type'] <-'RoRo Cargo/Vehicle'
emissions[emissions$ship_type == 'Cruise ship','ship_type']          <-'Passenger (cruise)'
emissions[emissions$ship_type == 'Passenger', 'ship_type']           <-'Passenger (ferry)'
# Add vessel group type to the emissions, for matching with GPS data
emissions                 <- left_join(emissions, unique(vessel_class[,c('aggregated_class', 'group')]),
by = c('ship_type' = 'aggregated_class'))
# Now aggregte
emissions <- emissions %>%
select(-ship_type) %>%
group_by(pollutant, cellid, group) %>%
summarise(sailing = sum(sailing, na.rm=T),
berth   = sum(berth, na.rm=T)) %>%
ungroup()
emissions
# Now get the grid by exact cut
grid                      <- st_read('grids/LAEIGridExtensionV2.gpkg', quiet = T)
grid
st_geometry(grid)
st_geometry(grid)[1:10]
plot(st_geometry(grid)[1:10])
plot(st_geometry(grid)[1:10])
plot(st_geometry(grid)[1:100])
# Link grid exact cut to eimssions exact cut, and remove some unncecessary data
grid_emissions            <- left_join(emissions, grid, by = c('cellid' = 'CellID')) %>%
rename(large_grid_id = GRID_ID0, x = X_COORD, y = Y_COORD) %>%
select(cellid, large_grid_id, x, y, pollutant, group, sailing, berth) %>%
as.tibble() %>%
group_by(pollutant, group, large_grid_id, x, y) %>%
summarise(sailing = sum(sailing), berth = sum(berth)) %>%
st_as_sf(coords = c("x", "y"), crs=27700) %>%
st_buffer(dist = 500, endCapStyle= "SQUARE")
grid_emissions
rm(emissions, grid)
## Setup the small grids
small_grid                         <- unique(grid_emissions[,c('large_grid_id','geometry')]) %>%
st_make_grid(cellsize = 20, what = 'polygons') %>%
st_sf() %>%
st_intersection(unique(grid_emissions[,c('large_grid_id','geometry')])) %>%
mutate(small_grid_id = row_number())
small_grid
grid_emissions[,c('large_grid_id','geometry')]
unique(grid_emissions[,c('large_grid_id','geometry')])
st_geometry(unique(grid_emissions[,c('large_grid_id','geometry')]))
plot(st_geometry(unique(grid_emissions[,c('large_grid_id','geometry')])))
unique(grid_emissions[,c('large_grid_id','geometry')]) %>%
st_make_grid(cellsize = 20, what = 'polygons')
